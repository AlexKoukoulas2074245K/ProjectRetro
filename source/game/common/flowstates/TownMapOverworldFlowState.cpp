//
//  TownMapOverworldFlowState.cpp
//  ProjectRetro
//
//  Created by Alex Koukoulas on 24/09/2019.
//

////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////

#include "TownMapOverworldFlowState.h"
#include "../components/GuiStateSingletonComponent.h"
#include "../utils/TextboxUtils.h"
#include "../../input/components/InputStateSingletonComponent.h"
#include "../../input/utils/InputUtils.h"
#include "../../overworld/utils/TownMapUtils.h"

////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////

const float TownMapOverworldFlowState::CURSOR_BLINKING_DELAY = 0.5f;

////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////

TownMapOverworldFlowState::TownMapOverworldFlowState(ecs::World& world)
    : BaseOverworldFlowState(world)
    , mCursorBlinkingTimer(CURSOR_BLINKING_DELAY)
    , mBackgroundCoverEntityId(LoadAndCreateTownMapBackgroundCover(mWorld))
    , mBackgroundEntityId(LoadAndCreateTownMapBackground(mWorld))
{            
    DestroyActiveTextbox(mWorld);        
}

void TownMapOverworldFlowState::VUpdate(const float)
{
    const auto& inputStateComponent = mWorld.GetSingletonComponent<InputStateSingletonComponent>();

    if 
    (
        IsActionTypeKeyTapped(VirtualActionType::A_BUTTON, inputStateComponent) ||
        IsActionTypeKeyTapped(VirtualActionType::B_BUTTON, inputStateComponent)
    )
    {
        mWorld.DestroyEntity(mBackgroundEntityId);
        mWorld.DestroyEntity(mBackgroundCoverEntityId);
        CompleteOverworldFlow();
    }
}

////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////


